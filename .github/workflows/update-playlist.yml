name: Update Merged Playlist

on:
  schedule:
    - cron: '0 3 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC (6 —É—Ç—Ä–∞ –ú–°–ö)
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
  push:  # –ü—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

jobs:
  build:
    runs-on: ubuntu-latest
    
    # –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    permissions:
      contents: write

    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout
      uses: actions/checkout@v4

    # –®–∞–≥ 2: –°–∫–∞—á–∏–≤–∞–µ–º, –æ–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    - name: Merge and deduplicate playlists
      run: |
        echo "üöÄ –ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤..."
        
        echo "üì• 1. –ó–∞–≥—Ä—É–∂–∞—é loganettv..."
        wget -q -O playlist1.m3u "https://loganettv.vercel.app/all.m3u"
        
        echo "üì• 2. –ó–∞–≥—Ä—É–∂–∞—é zabava-project..."
        wget -q -O playlist2.m3u "https://raw.githubusercontent.com/CrocoUser/zabava-project/main/zabava-full.m3u"
        
        echo "üì• 3. –ó–∞–≥—Ä—É–∂–∞—é IPTVstable..."
        wget -q -O playlist3.m3u "https://smolnp.github.io/IPTVru/IPTVstable.m3u8"
        
        echo "üßπ –£–¥–∞–ª—è—é –¥—É–±–ª–∏–∫–∞—Ç—ã..."
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        echo "#EXTM3U" > temp_all.m3u
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        cat playlist1.m3u playlist2.m3u playlist3.m3u >> temp_all.m3u
        
        # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ URL –∫–∞–Ω–∞–ª–æ–≤
        # –°–æ–∑–¥–∞–µ–º Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        python3 << 'EOF'
import sys

# –ß–∏—Ç–∞–µ–º –≤–µ—Å—å —Ñ–∞–π–ª
with open('temp_all.m3u', 'r', encoding='utf-8', errors='ignore') as f:
    lines = f.readlines()

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤: URL -> (EXTINF_line, group_line)
channels = {}
current_extinf = ""
current_group = ""
current_url = ""
i = 0

while i < len(lines):
    line = lines[i].strip()
    
    if line.startswith("#EXTINF"):
        current_extinf = lines[i]
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É –≤ —Å—Ç—Ä–æ–∫–µ EXTINF
        current_group = ""
        if 'group-title="' in line:
            start = line.find('group-title="') + 13
            end = line.find('"', start)
            current_group = line[start:end]
        i += 1
        continue
    
    elif line.startswith("#EXTGRP") or line.startswith("#EXTVLCOPT"):
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
        i += 1
        continue
    
    elif line and not line.startswith("#"):
        # –≠—Ç–æ URL –∫–∞–Ω–∞–ª–∞
        current_url = line
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π URL
        if current_url not in channels:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–Ω–∞–ª
            channels[current_url] = (current_extinf, current_group)
        else:
            # –î—É–±–ª–∏–∫–∞—Ç –Ω–∞–π–¥–µ–Ω - –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å
            old_extinf = channels[current_url][0]
            print(f"‚ö†Ô∏è –ù–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç: {current_url[:50]}...")
            
            # –ï—Å–ª–∏ —É –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –µ—Å—Ç—å –≥—Ä—É–ø–ø–∞, –∞ —É —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º
            if current_group and not channels[current_url][1]:
                channels[current_url] = (current_extinf, current_group)
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        current_extinf = ""
        current_group = ""
        current_url = ""
    
    i += 1

# –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
with open('merged.m3u', 'w', encoding='utf-8') as f:
    f.write("#EXTM3U\n")
    f.write("# –ù–∞–∑–≤–∞–Ω–∏–µ: –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤\n")
    f.write(f"# –û–±–Ω–æ–≤–ª–µ–Ω–æ: $(date '+%Y-%m-%d %H:%M:%S') UTC\n")
    f.write("# –ò—Å—Ç–æ—á–Ω–∏–∫–∏:\n")
    f.write("# 1. https://loganettv.vercel.app/all.m3u\n")
    f.write("# 2. https://raw.githubusercontent.com/CrocoUser/zabava-project/main/zabava-full.m3u\n")
    f.write("# 3. https://smolnp.github.io/IPTVru/IPTVstable.m3u8\n")
    f.write("# –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: —É–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ URL\n")
    f.write("#\n")
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
    for url, (extinf, group) in channels.items():
        f.write(extinf)
        if group:
            f.write(f"#EXTGRP:{group}\n")
        f.write(url + "\n")

print(f"‚úÖ –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: {len(lines) // 2 - len(channels)}")
print(f"‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤: {len(channels)}")
EOF
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ Python –≤—ã–≤–æ–¥–∞
        unique_count=$(grep -c "^#EXTINF" merged.m3u || echo "0")
        
        echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
        echo "‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤: $unique_count"

    # –®–∞–≥ 3: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - name: Upload to GitHub
      run: |
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git add merged.m3u
        
        # –ö–æ–º–º–∏—Ç–∏–º —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–∞–Ω–∞–ª–æ–≤
        channel_count=$(grep -c "^#EXTINF" merged.m3u || echo "0")
        git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $(date '+%Y-%m-%d %H:%M') | –ö–∞–Ω–∞–ª–æ–≤: $channel_count" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        
        # –ü—É—à–∏–º
        git push
