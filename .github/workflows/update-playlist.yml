name: Update Merged Playlist

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Simple merge - NO DEDUPLICATION
      run: |
        # –°–∫–∞—á–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞
        curl -s -L "https://loganettv.vercel.app/all.m3u" -o p1.m3u
        curl -s -L "https://raw.githubusercontent.com/CrocoUser/zabava-project/main/zabava-full.m3u" -o p2.m3u
        curl -s -L "https://smolnp.github.io/IPTVru/IPTVstable.m3u8" -o p3.m3u
        
        # –ü–†–û–°–¢–û –°–ö–õ–ï–ò–í–ê–ï–ú, –ù–ï –¢–†–û–ì–ê–ï–ú –î–£–ë–õ–ò–ö–ê–¢–´
        echo "#EXTM3U" > merged.m3u
        echo "# –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç (–≤—Å–µ —Ç—Ä–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞)" >> merged.m3u
        echo "# –û–±–Ω–æ–≤–ª–µ–Ω–æ: $(date '+%Y-%m-%d %H:%M:%S')" >> merged.m3u
        echo "" >> merged.m3u
        
        # –°–∫–ª–µ–∏–≤–∞–µ–º –≤—Å–µ –∫–∞–∫ –µ—Å—Ç—å
        cat p1.m3u >> merged.m3u
        echo "" >> merged.m3u
        cat p2.m3u >> merged.m3u  
        echo "" >> merged.m3u
        cat p3.m3u >> merged.m3u
        
        # –°—á–∏—Ç–∞–µ–º
        count1=$(grep -c "^#EXTINF" p1.m3u || echo "0")
        count2=$(grep -c "^#EXTINF" p2.m3u || echo "0")
        count3=$(grep -c "^#EXTINF" p3.m3u || echo "0")
        total=$((count1 + count2 + count3))
        
        echo "–ü–ª–µ–π–ª–∏—Å—Ç 1: $count1 –∫–∞–Ω–∞–ª–æ–≤"
        echo "–ü–ª–µ–π–ª–∏—Å—Ç 2: $count2 –∫–∞–Ω–∞–ª–æ–≤"
        echo "–ü–ª–µ–π–ª–∏—Å—Ç 3: $count3 –∫–∞–Ω–∞–ª–æ–≤"
        echo "–í—Å–µ–≥–æ –≤ merged.m3u: $total –∫–∞–Ω–∞–ª–æ–≤ (—Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏)"
    
    - name: Push to repo
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        
        git add merged.m3u
        
        # –°—á–∏—Ç–∞–µ–º –∫–∞–Ω–∞–ª—ã –¥–ª—è –∫–æ–º–º–∏—Ç–∞
        channel_count=$(grep -c "^#EXTINF" merged.m3u || echo "0")
        git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $(date '+%Y-%m-%d %H:%M') | –ö–∞–Ω–∞–ª–æ–≤: $channel_count" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        
        git push
