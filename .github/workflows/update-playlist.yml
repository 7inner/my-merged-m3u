name: Update Merged Playlist

on:
  schedule:
    # Запускается каждый день в 03:00 UTC (в 6 утра по Москве, если нет перехода на летнее время).
    - cron: '0 3 * * *'
  workflow_dispatch: # Позволяет запустить вручную из интерфейса GitHub
  push: # Запускается при любом изменении в репозитории (удобно для отладки)

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download and merge playlists
      run: |
        # Скачиваем первый плейлист
        curl -s -L "https://loganettv.vercel.app/all.m3u" -o playlist1.m3u
        # Скачиваем второй плейлист
        curl -s -L "https://raw.githubusercontent.com/CrocoUser/zabava-project/refs/heads/main/zabava-full.m3u" -o playlist2.m3u
        # Объединяем их в один файл, добавляя заголовок
        echo "#EXTM3U Merged Playlist - Auto Updated" > merged.m3u
        echo "# Объединение от $(date -u)" >> merged.m3u
        cat playlist1.m3u playlist2.m3u >> merged.m3u
        # Подсчитываем количество каналов (строк с #EXTINF)
        COUNT=$(grep -c "^#EXTINF" merged.m3u)
        echo "Объединенный плейлист содержит примерно $COUNT каналов."

    - name: Upload merged playlist to repository
      run: |
        # Настраиваем Git
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        # Добавляем, коммитим и пушим изменения
        git add merged.m3u
        git commit -m "Auto-update: merged playlist $(date -u)" || echo "No changes to commit"
        git push
